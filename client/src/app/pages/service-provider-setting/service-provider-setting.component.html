<ng-container *ngIf="showPageWrapper; else formOnly">
    <app-page title="Service Provider Profile">
        <ng-container *ngTemplateOutlet="formContent"></ng-container>
    </app-page>
</ng-container>

<ng-template #formOnly>
    <ng-container *ngTemplateOutlet="formContent"></ng-container>
</ng-template>

<ng-template #formContent>
    <form (ngSubmit)="submitProviderForm()" class="space-y-8">
        <app-section title="Logo" subtitle="Used on proposals and client-facing materials.">
            <ng-container *ngIf="!readonly">
                <app-profile-picture-upload [maxSizeKb]="500" [title]="'Company Logo'"
                    [subtitle]="'Square logo recommended for best results.'">
                </app-profile-picture-upload>
            </ng-container>
            <ng-container *ngIf="readonly">
                <div *ngIf="getProfileImageUrl(); else noLogo">
                    <img [src]="getProfileImageUrl()" alt="Company logo" class="w-32 h-32 object-contain">
                </div>
                <ng-template #noLogo>
                    <p class="text-sm text-gray-600">No logo available.</p>
                </ng-template>
            </ng-container>
        </app-section>

        <app-section title="Company" subtitle="Core registration details.">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col">
                    <app-base-input label="Legal Company Name" name="legalCompanyName"
                        [(ngModel)]="providerFormModel.legalCompanyName" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.legalCompanyName || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Trading Name (Optional)" name="tradingName"
                        [(ngModel)]="providerFormModel.tradingName" [disabled]="readonly">
                    </app-base-input>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Company Registration Number" name="companyRegistrationNumber"
                        [(ngModel)]="providerFormModel.companyRegistrationNumber" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message
                        [errorMessage]="providerErrors.companyRegistrationNumber || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Year of Establishment (Optional)" name="yearOfEstablishment" type="number"
                        [(ngModel)]="providerFormModel.yearOfEstablishment" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.yearOfEstablishment || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Tax Registration Number (Optional)" name="taxRegistrationNumber"
                        [(ngModel)]="providerFormModel.taxRegistrationNumber" [disabled]="readonly">
                    </app-base-input>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Company Website (Optional)" name="companyWebsite" type="text"
                        [(ngModel)]="providerFormModel.companyWebsite" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.companyWebsite || null"></app-error-message>
                </div>
            </div>
        </app-section>

        <app-section title="Head Office Address" subtitle="Used for billing and compliance.">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col">
                    <app-base-input label="Street Address" name="officeStreet"
                        [(ngModel)]="providerFormModel.headOfficeAddress.street" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.officeStreet || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="City" name="officeCity"
                        [(ngModel)]="providerFormModel.headOfficeAddress.city" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.officeCity || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-select-input label="Country" name="officeCountry"
                        [(ngModel)]="providerFormModel.headOfficeAddress.country" [options]="countryOptions"
                        placeholder="-- Select Country --" [required]="true" [searchable]="true"
                        [disabled]="true"></app-select-input>
                    <app-error-message [errorMessage]="providerErrors.officeCountry || null"></app-error-message>
                </div>

                <div class="flex flex-col" *ngIf="providerFormModel.headOfficeAddress.country === 'CA'">
                    <app-select-input label="Province" name="officeProvince"
                        [(ngModel)]="providerFormModel.headOfficeAddress.province" [options]="provinceOptions"
                        placeholder="-- Select Province --" [required]="true" [searchable]="true" [disabled]="readonly"></app-select-input>
                    <app-error-message [errorMessage]="providerErrors.officeProvince || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Postal Code" name="officePostalCode"
                        [(ngModel)]="providerFormModel.headOfficeAddress.postalCode" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.officePostalCode || null"></app-error-message>
                </div>
            </div>
        </app-section>

        <app-section title="Primary Representative" subtitle="Single point of contact.">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col md:col-span-1">
                    <app-base-input label="Representative Name" name="repName"
                        [(ngModel)]="providerFormModel.primaryRepresentative.name" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.repName || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-1">
                    <app-base-input label="Representative Email" name="repEmail" type="email"
                        [(ngModel)]="providerFormModel.primaryRepresentative.email" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.repEmail || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-1">
                    <app-mobile-phone-input label="Mobile Phone" name="repMobile"
                        [(ngModel)]="providerFormModel.primaryRepresentative.mobilePhone" [defaultCountry]="'CA'"
                        [disableCountrySelector]="true" helperText="Enter mobile number" [disabled]="readonly">
                    </app-mobile-phone-input>
                    <app-error-message [errorMessage]="providerErrors.repMobilePhone || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-1">
                    <app-landline-phone-input label="Landline Phone (Optional)" name="repLandline"
                        [(ngModel)]="providerFormModel.primaryRepresentative.landlinePhone" [defaultCountry]="'CA'"
                        [disableCountrySelector]="true" helperText="Enter landline number" [disabled]="readonly">
                    </app-landline-phone-input>
                    <app-error-message [errorMessage]="providerErrors.repLandlinePhone || null"></app-error-message>
                </div>

                <div class="col-span-1 md:col-span-2" *ngIf="providerErrors.repPhone">
                    <app-error-message [errorMessage]="providerErrors.repPhone || null"></app-error-message>
                </div>
            </div>
        </app-section>

        <app-section title="Secondary Contact" subtitle="Backup contact for urgent updates.">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col md:col-span-1">
                    <app-base-input label="Contact Name" name="secondaryContactName"
                        [(ngModel)]="providerFormModel.secondaryContact.name" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.secondaryContactName || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-1">
                    <app-base-input label="Contact Email" name="secondaryContactEmail" type="email"
                        [(ngModel)]="providerFormModel.secondaryContact.email" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message
                        [errorMessage]="providerErrors.secondaryContactEmail || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-1">
                    <app-mobile-phone-input label="Mobile Phone" name="secondaryContactMobile"
                        [(ngModel)]="providerFormModel.secondaryContact.mobilePhone" [defaultCountry]="'CA'"
                        [disableCountrySelector]="true" helperText="Enter mobile number" [disabled]="readonly">
                    </app-mobile-phone-input>
                    <app-error-message
                        [errorMessage]="providerErrors.secondaryContactMobilePhone || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-1">
                    <app-landline-phone-input label="Landline Phone (Optional)" name="secondaryContactLandline"
                        [(ngModel)]="providerFormModel.secondaryContact.landlinePhone" [defaultCountry]="'CA'"
                        [disableCountrySelector]="true" helperText="Enter landline number" [disabled]="readonly">
                    </app-landline-phone-input>
                    <app-error-message
                        [errorMessage]="providerErrors.secondaryContactLandlinePhone || null"></app-error-message>
                </div>

                <div class="col-span-1 md:col-span-2" *ngIf="providerErrors.secondaryContactPhone">
                    <app-error-message
                        [errorMessage]="providerErrors.secondaryContactPhone || null"></app-error-message>
                </div>
            </div>
        </app-section>

        <app-section title="Security License" subtitle="Must be active to deploy guards.">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col">
                    <app-base-input label="License Number" name="licenseNumber"
                        [(ngModel)]="providerFormModel.securityLicense.licenseNumber" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.licenseNumber || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-select-input label="License Type" name="licenseType"
                        [(ngModel)]="providerFormModel.securityLicense.licenseType"
                        [options]="securityLicenseTypeOptions" placeholder="-- Select License Type --" [required]="true"
                        [searchable]="false" [disabled]="readonly"></app-select-input>
                    <app-error-message [errorMessage]="providerErrors.licenseType || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-select-input label="Issuing Province" name="issuingProvince"
                        [(ngModel)]="providerFormModel.securityLicense.issuingProvince" [options]="provinceOptions"
                        placeholder="-- Select Province --" [required]="true" [searchable]="true"
                        (ngModelChange)="onIssuingProvinceChange()" [disabled]="readonly"></app-select-input>
                    <app-error-message [errorMessage]="providerErrors.issuingProvince || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Issuing Authority" name="issuingAuthority"
                        [(ngModel)]="providerFormModel.securityLicense.issuingAuthority" [required]="true"
                        [placeholder]="getSuggestedIssuingAuthority(providerFormModel.securityLicense.issuingProvince) || 'e.g., Ministry of the Solicitor General'"
                        helperText="Will auto-populate based on selected province" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.issuingAuthority || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Issue Date (Optional)" name="issueDate" type="date"
                        [(ngModel)]="providerFormModel.securityLicense.issueDate" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.issueDate || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Expiry Date" name="expiryDate" type="date"
                        [(ngModel)]="providerFormModel.securityLicense.expiryDate" [required]="true" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.expiryDate || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-2">
                    <ng-container *ngIf="!readonly">
                        <app-file-upload label="License Document" name="licenseDocument"
                            [(ngModel)]="providerFormModel.securityLicense.file"
                            (fileChange)="onSecurityLicenseFileSelected($event)"
                            [existingFileUrl]="providerFormModel.securityLicense.existingFileUrl"
                            [existingFileName]="providerFormModel.securityLicense.existingFileName"
                            helperText="PNG, JPG, PDF up to 10MB" [required]="false"
                            [disabled]="securityLicenseUploadInProgress"></app-file-upload>
                        <p class="text-xs text-gray-500 mt-2">Optional upload now avoids later holds.</p>
                        <p *ngIf="securityLicenseUploadInProgress" class="text-xs text-primary-600 mt-2">Uploading
                            document...</p>
                        <app-error-message [errorMessage]="securityLicenseUploadError || null"></app-error-message>
                    </ng-container>
                    <ng-container *ngIf="readonly">
                        <app-file-upload *ngIf="providerFormModel.securityLicense.existingFileUrl"
                            [existingFileUrl]="providerFormModel.securityLicense.existingFileUrl"
                            [existingFileName]="providerFormModel.securityLicense.existingFileName"
                            [viewOnly]="true">
                        </app-file-upload>
                    </ng-container>
                </div>
            </div>
        </app-section>

        <app-section title="Insurance" subtitle="Active coverage is required for provider approval.">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col">
                    <app-base-input label="Policy Number" name="policyNumber"
                        [(ngModel)]="providerFormModel.insuranceDetails.policyNumber" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.policyNumber || null"></app-error-message>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Coverage Amount" name="coverageAmount" type="number"
                        [(ngModel)]="providerFormModel.insuranceDetails.coverageAmount" [disabled]="readonly">
                    </app-base-input>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Currency" name="coverageCurrency"
                        [disabled]="true"
                        [(ngModel)]="providerFormModel.insuranceDetails.currency">
                    </app-base-input>
                </div>

                <div class="flex flex-col">
                    <app-base-input label="Policy Expiry Date" name="policyExpiryDate" type="date"
                        [(ngModel)]="providerFormModel.insuranceDetails.expiryDate" [disabled]="readonly">
                    </app-base-input>
                    <app-error-message [errorMessage]="providerErrors.policyExpiryDate || null"></app-error-message>
                </div>

                <div class="flex flex-col md:col-span-2">
                    <app-base-input label="Coverage Details (Optional)" name="coverageDetails"
                        [(ngModel)]="providerFormModel.insuranceDetails.coverageDetails" [disabled]="readonly">
                    </app-base-input>
                </div>
            </div>
        </app-section>

        <app-section title="Operating Regions" subtitle="Where you can deploy guards.">
            <ng-container section-actions>
                <app-button [label]="'Add region'" type="outline" [htmlType]="'button'"
                    [customClass]="'hidden md:inline-flex rounded-lg'" (click)="addRegion()">
                </app-button>
            </ng-container>

            <div class="space-y-4">
                <app-card *ngFor="let region of providerFormModel.operatingRegions; let i = index trackBy: trackByIndex"
                    class="block" [bodyClass]="'mt-4'">
                    <div card-header>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200">
                            {{ region.city ? region.city : ('Region ' + (i + 1)) }}
                        </h3>
                    </div>
                    <div card-actions *ngIf="providerFormModel.operatingRegions.length > 1 && !readonly">
                        <app-button label="Remove" type="danger" htmlType="button" size="sm" (click)="removeRegion(i)">
                        </app-button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="flex flex-col">
                            <app-base-input label="City" [name]="'regionCity' + i"
                                [(ngModel)]="providerFormModel.operatingRegions[i].city" [required]="i === 0" [disabled]="readonly">
                            </app-base-input>
                            <app-error-message
                                [errorMessage]="providerErrors['region_' + i + '_city'] || null"></app-error-message>
                        </div>

                        <div class="flex flex-col">
                            <app-select-input label="Country" [name]="'regionCountry' + i"
                                [(ngModel)]="providerFormModel.operatingRegions[i].country" [options]="countryOptions"
                                placeholder="-- Select Country --" [required]="i === 0" [searchable]="true"
                                [disabled]="true"></app-select-input>
                            <app-error-message
                                [errorMessage]="providerErrors['region_' + i + '_country'] || null"></app-error-message>
                        </div>

                        <div class="flex flex-col" *ngIf="providerFormModel.operatingRegions[i].country === 'CA'">
                            <app-select-input label="Province" [name]="'regionProvince' + i"
                                [(ngModel)]="providerFormModel.operatingRegions[i].province" [options]="provinceOptions"
                                placeholder="-- Select Province --" [required]="i === 0"
                                [searchable]="true" [disabled]="readonly"></app-select-input>
                            <app-error-message
                                [errorMessage]="providerErrors['region_' + i + '_province'] || null"></app-error-message>
                        </div>

                        <div class="flex flex-col">
                            <app-base-input label="Coverage Radius (km)" [name]="'regionRadius' + i" type="number"
                                [(ngModel)]="providerFormModel.operatingRegions[i].coverageRadiusKm" [min]="1" [disabled]="readonly">
                            </app-base-input>
                            <app-error-message
                                [errorMessage]="providerErrors['region_' + i + '_radius'] || null"></app-error-message>
                        </div>
                    </div>
                </app-card>

                <app-error-message [errorMessage]="providerErrors.operatingRegions || null"></app-error-message>

                <div class="flex justify-center pt-4 md:hidden" *ngIf="!readonly">
                    <app-button [label]="'+ Add Another Region'" type="secondary" [htmlType]="'button'"
                        [customClass]="'rounded-lg'" (click)="addRegion()">
                    </app-button>
                </div>
            </div>
        </app-section>

        <app-section title="Guard Categories Offered" subtitle="E.g., Patrol, Concierge, Event.">
            <div class="grid grid-cols-1 gap-6">
                <app-guard-types-multiselect label="Guard Categories" placeholder="-- Select Categories --"
                    [(ngModel)]="providerFormModel.guardCategoriesOffered" [options]="guardTypeOptions"
                    [required]="true" name="guardCategoriesOffered" [disabled]="readonly">
                </app-guard-types-multiselect>
                <app-error-message [errorMessage]="providerErrors.guardCategories || null"></app-error-message>
            </div>
        </app-section>

        <div *ngIf="providerErrors.submit"
            class="rounded-lg border border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/40 p-4">
            <app-error-message [errorMessage]="providerErrors.submit"></app-error-message>
        </div>

        <app-sticky-action-bar *ngIf="!readonly" [message]="'Save to activate your provider profile.'" [containerClass]="'px-0'">
            <app-button *ngIf="!isEditMode" [label]="'Submit'" type="primary" [htmlType]="'submit'" [fullWidth]="true"
                size="lg" [customClass]="'w-full md:w-auto rounded-lg'">
            </app-button>
            <app-button *ngIf="isEditMode" [label]="'Save Changes'" type="success" [htmlType]="'submit'"
                [fullWidth]="true" size="lg" [customClass]="'w-full md:w-auto rounded-lg'">
            </app-button>
        </app-sticky-action-bar>
    </form>
</ng-template>