worker_processes auto;

events {
    worker_connections 8192;
}

http {
    include /etc/nginx/mime.types;
    open_file_cache off;
    server_tokens off;
    server_names_hash_bucket_size 128;
    autoindex off;

    map $request_method $upstream_method {
        default $request_method;
        HEAD GET;
    }

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=static_cache:10m max_size=1g inactive=60m use_temp_path=off;

    brotli on;
    brotli_comp_level 8;
    brotli_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        text/xml
        application/xml
        image/svg+xml
        application/x-javascript
        text/x-js;
    brotli_min_length 20;

    gzip on;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        text/xml
        application/xml
        image/svg+xml
        application/x-javascript
        text/x-js;
    gzip_min_length 20;
    gzip_vary on;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header Server "Secure Gateway" always;

    map $request_uri $bad_traversal {
        default 0;
        ~*"\.\./" 1;
        ~*"%2e%2e/" 1;
        ~*"\.%2e/" 1;
        ~*"%2e\./" 1;
        ~*"%2f\.\.%2f" 1;
        ~*"%5c\.\.%5c" 1;
    }

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_connect_timeout 5s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
    send_timeout 120s;
    client_body_buffer_size 8m;

    server {
        listen 80;
        server_name try.orionintelligence.org;
        client_max_body_size 16m;

        location /.well-known/acme-challenge/ {
            alias /var/www/letsencrypt/;
            try_files $uri =404;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl;
        client_max_body_size 16m;
        http2 on;
        server_name try.orionintelligence.org;

        if ($bad_traversal) { return 403; }

        ssl_certificate /etc/letsencrypt/live/try.orionintelligence.org/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/try.orionintelligence.org/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_stapling on;
        ssl_stapling_verify on;
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 10s;

        error_page 404 /404.html;
        error_page 403 /403.html;
        error_page 405 500 502 503 504 /500.html;

        location = /robots.txt {
            alias /app/static/robots.txt;
            add_header Cache-Control "public, max-age=1";
        }

        location ~ /\.(?!well-known/) {
            deny all;
        }

        location /api/ {
            proxy_method $upstream_method;
            proxy_request_buffering on;
            proxy_pass http://trusted-web-main:8070;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header Accept-Encoding "br,gzip,deflate";
            proxy_pass_request_headers on;
            proxy_intercept_errors off;
            proxy_hide_header X-Powered-By;
            proxy_hide_header Server;
            proxy_hide_header X-AspNet-Version;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }

        location /admin/ {
            proxy_method $upstream_method;
            proxy_request_buffering on;
            proxy_pass http://trusted-web-main:8070;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header Accept-Encoding "br,gzip,deflate";
            proxy_pass_request_headers on;
            proxy_intercept_errors on;
            proxy_hide_header X-Powered-By;
            proxy_hide_header Server;
            proxy_hide_header X-AspNet-Version;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }

        location / {
            proxy_method $upstream_method;
            proxy_request_buffering on;
            proxy_intercept_errors on;
            proxy_pass http://trusted-web-main:8070;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header Accept-Encoding "br,gzip,deflate";
            proxy_pass_request_headers on;
            proxy_hide_header X-Powered-By;
            proxy_hide_header Server;
            proxy_hide_header X-AspNet-Version;
            add_header Cache-Control "private, max-age=15, must-revalidate";
        }

        location /static/ {
            alias /app/static/;
            index index.html;

            proxy_cache static_cache;
            proxy_cache_valid 200 302 30d;
            proxy_cache_valid 404 1h;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_revalidate on;
            proxy_cache_lock on;

            brotli_static on;
            gzip_static on;

            types {
                image/svg+xml svg;
                text/javascript js;
                text/css css;
                font/ttf ttf;
                font/woff woff;
                font/woff2 woff2;
                image/webp webp;
            }

            try_files $uri =404;

            add_header Access-Control-Allow-Origin *;
            add_header Cache-Control "public, max-age=15, immutable";
        }

        location = /403.html {
            root /app/static;
            internal;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }

        location = /404.html {
            root /app/static;
            internal;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }

        location = /500.html {
            root /app/static;
            internal;
            add_header Cache-Control "no-store, no-cache, must-revalidate";
        }
    }

    server {
        listen 80;
        client_max_body_size 16m;
        server_name o2k3sgzqpl3o6kmx22uqxhcz2bgb34kor46wmbqvsn7vzikfxn6y66ad.onion;

        location / {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin *;
                add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
                add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type 'text/plain charset=UTF-8';
                add_header Content-Length 0;
                return 204;
            }

            proxy_method $upstream_method;
            proxy_request_buffering on;
            proxy_pass http://trusted-web-main:8070;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto http;
            proxy_hide_header X-Powered-By;
            proxy_hide_header Server;
            proxy_hide_header X-AspNet-Version;

            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
            add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
            add_header Access-Control-Expose-Headers 'Content-Length,Content-Range' always;
        }
    }
}
